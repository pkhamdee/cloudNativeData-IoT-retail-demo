# Cloud Native Data Demo - Greenplum portion

* This code implements the Greenplum (GP) portion of the cloud native data demo/workshop
* This assumes a GP 5.X instance is running.  We used a single instance created in the AWS marketplace.
* There is a GP role/user called **retail** that owns a database called **retail**.
  * The user can create external tables
  * There is no Linux retail user
* Within the retail database there is a **pivotalmarkets** schema. All the work is done in that schema.
* **MADlib** is loaded in the retail db and the retail user is granted all permissions to the `madlib` schema.
* The required files are in `/home/gpadmin/RetailDemo` directory
* The following line has been added to the `pg_hba.conf` configuration file (yes, we could require a password, but we don't).
`host    retail      retail        0.0.0.0/0  trust`
* Certain images for the promotions exist in AWS S3 and are publicly readable.

## Data assumptions:
### The app requires this information.
* information about the beacons within the stores
* the most common purchase for each customer
* which products tend to be bought together
* current store promotions

### The app provides the following information
* which beacons the customer hits (store, beacon, time)

## Required GP tables

### beacon
All have the same uuid, major is store id, minor is location in store

Minor = 0 is the entrance, minor = 99 is checkout, 1-11 are the aisles, corresponding to category
~~~
 create table beacon  (
  uuid text,
  major int,
  minor int,
  category text
)
distributed randomly;
~~~
### category
Category = 1..11 representing aisles and product category, subcategory is the product itself
~~~
create table category (
  categoryID int,
  categoryName text,
  subcategoryID int,
  subcategoryname text
)
distributed randomly;

select distinct categoryname, categoryid from category order by categoryid;
      categoryname      | categoryid
------------------------+------------
 beverage               |          1
 produce                |          2
 dairy                  |          3
 frozen foods           |          4
 paper goods            |          5
 meat                   |          6
 deli                   |          7
 bakery                 |          8
 condiments             |          9
 canned goods           |         10
 health and beauty aids |         11
~~~

### customers

This table is generated by Mockaroo.

There are 1000 customers with **customerid running from 1000 to 1099** and all customers live in **California**.
~~~
create table customers (
  customerId integer,
  deviceId text,
  firstName text,
  lastName text,
  street text,
  city text,
  state text,
  zipcode char(5),
  mobileNumber text,
  openDate date,
  lastUpdate date
)
distributed randomly;

select * from customers limit 1;
-[ RECORD 1 ]+------------------
customerid   | 1001
deviceid     | C6-13-77-B1-3F-53
firstname    | Andriana
lastname     | Kleiner
street       | 25 Sachs Drive
city         | Sacramento
state        | California
zipcode      | 95852
mobilenumber | 916-413-3658
opendate     | 2015-12-27
lastupdate   | 2017-11-29
~~~
### product

The entries for this table are hand built.  The ones whose names begin with **Pivotal** are house brands.
~~~
create table product (
  productId int,
  productName text,
  categoryId int,
  subCategoryId int,
  unit numeric default NULL,
  cost numeric default NULL,
  price numeric default NULL,
  startDate date default NULL,
  endDate date default NULL,
  createdDate date default NULL,
  lastUpdatedDate date default NULL
)
distributed randomly;

select productid, productname, categoryid, subcategoryid  from product where productname like 'Pivotal%';
productid |           productname           | categoryid | subcategoryid
----------+---------------------------------+------------+---------------
        6 | Pivotal Smoothie                |          1 |          1999
       26 | Pivotal 2% Milk                 |          3 |          3001
       30 | Pivotal 1/2 and 1/2             |          3 |          3005
       34 | Pivotal Small Frozen Peas       |          4 |          4002
        1 | Pivotal Apple Juice             |          1 |          1001
       77 | Pivotal Baked Beans             |         10 |         10005
       81 | Pivotal Extra Strength Aspirin  |         11 |         11012
       80 | Pivotal Stomach Calmer          |         11 |         11010
       39 | Pivotal Soft and Smooth 24 pack |          5 |          5001
       27 | Pivotal Low Fat Yoghurt         |          3 |          3002
~~~
### stores

This table is generated by Mockaroo.

There are 100 stores with **storeid running from 1 to 100**
All are located in California and have LAT/LONG in case we want to display them on a map or calculate distance.
~~~
create table stores  (
  storeID int,
  name text,
  street text,
  city text,
  state text,
  zipcode char(5),
  longitude double precision,
  latitude double precision
)
distributed randomly;

select * from stores limit 1;
-[ RECORD 1 ]------------------
storeid   | 1
name      | PivotalMarket
street    | 402 Shasta Junction
city      | San Diego
state     | California
zipcode   | 92191
longitude | -116.846
latitude  | 33.0169
~~~
### orders and order_items

Orders are generated in Mockaroo, but make use of the fact that customer ids are known and range from 1000-1099 and store ids are known and range from 1-100

order_items are generated by the `build_order_items.py` script.
For each order in the orders table, a random number of items is generated.  
~~~
drop table if exists orders;
create table orders (
  orderid integer,
  customerid integer,
  storeid integer,
  orderdate date
) distributed randomly;

drop table if exists order_items;
create table order_items (
  itemid integer,
  orderid integer,
  productid integer,
  quantity float8
) distributed randomly;

select * from order_items where orderid=2;
 itemid | orderid | productid | quantity |              productname              
--------+---------+-----------+----------+---------------------------------------
     13 |       2 |        43 |        1 |  T-bone steak
     12 |       2 |        81 |        1 |  Pivotal Extra Strength Aspirin
     11 |       2 |        78 |        1 |  Jasper's Pizza Sauce
     15 |       2 |        61 |        1 |  Brooklyn Bagel 6 pack
     14 |       2 |        79 |        1 |  Devil's Delight Blazing Hot Sausage
~~~

### promotions

The app can show the shopper a promotion:
* if a product is one of his/her favorites or
* if the customer passes an aisle beacon where the product is housed or
* if the association rules show this customer buys a product that is highlighted by the asso_rules table.

~~~
create table promotion (
  promotionID int,
  startDate date,
  endDate date,
  marketingMessage text,
  marketingimageurl text
)
distributed randomly;

select * from promotion limit 1;
-[ RECORD 1 ]-----+--------------------------------------------------------------------------------
promotionid       | 1
startdate         | 2018-08-31
enddate           | 2018-12-31
marketingmessage  | $4 off Jasper's New Haven Style Apizza
marketingimageurl | https://s3.amazonaws.com/greenplum-workshop-artifacts-mpresser/JasperPizza.jpg
~~~
### beaconrequest and beaconresponse
These tables are populated by the app, reacting to customer movements in the store, promotions, and the like.
~~~
create table beaconrequest (
  customerId int,
  deviceId text,
  major int,
  minor int,
  signalPower int
)
distributed randomly;

create table beaconresponse (
  customerId int,
  deviceId text,
  major int,
  minor int,
  signalPower int,
  promotionID int,
  marketingMessage text,
  marketingimageurl text
)
distributed randomly;
~~~

## Building the GP environment

### The quick 4 step build process
Once you have cloned or downloaded the files in this repository, you can build the demo by running 5 scripts.
They amalgamate the many scripts listed in the following section.
Running the individual scripts may give you a better sense of the structure of the data.

The basic setup script must be run first as the gpadmin user:
`psql -h <host>  -d postgres -p 6432 -U gpadmin -f ./00_basic_setup.sql`

The 01 - 04 scripts are run as the retail user:
~~~
psql -h <hostname or host ip addr>  -d retail -p 6432 -U retail
$ \i 00_basic_setup.sql
$ \i 01_create_schema_and_tables.sql
$ \i 02_load_base_tables.sql
$ \i 03_load_items_tables.sql
$ \i 04_analyze_orders.sql
~~~
### More manual build method
### Create the tables

Run the following SQL scripts.
  If using psql, the following command should work without a password.
~~~~
psql -h <hostname or host ip addr>  -d retail -p 6432 -U retail
~~~~

* create_beacon_request.sql
* create_beacon_response.sql
* create_beacon.sql
* create_category.sql
* create_customer_category.sql  -- not currently used
* create_customers.sql
* create_order.sql -- Note: create_orders.sql creates both the orders and order_items tables
* create_product.sql
* create_promotion.sql
* create_stores.sql
* build_customer_favorites.sql -- builds the customer_favorites table

### Check the CSV data tables for the base tables

* beacons.csv  -- generated by `build_beacons.py`
* category.csv  -- hand built
* customers.csv  -- generated by Mockaroo
* stores.csv  -- generated by Mockaroo
* Orders0.csv, Orders1.csv, Orders2.csv, Orders3.csv, Orders4.csv, Orders5.csv -- generated by Mockaroo
    * there are 6 of these because Mockaroo only lets you generate 1000 rows per CSV in the free version
* product.csv -- hand built
* productname.csv, productid.csv -- needed by python scripts for derived tables.  DO NOT REMOVE

### Load the base tables with the following SQL scripts

* load_beacon.sql
* load_category.sql
* load_customers.sql
* load_orders.sql
* load_products.sql
* load_promotions.sql
* load_stores.sql  

### Build the order_items and load the order_items table.
This is done by the `build_order_items.py` script which creates a random number of items for each of the orders in the orders table with the output going to the `order_items.csv` file.

Since the choices are random, there is unlikely to be any strong association between two particular items, such as the beer and diapers story.   
To make the assoc_rules show something, we generate some commonly purchased pairs of products. Two python scripts generate these pairs:
* `add_aspirin_diapers.py` generates `aspirin-diapers.csv`
* `add_sausage_calmer.py` generates `sausage-calmer.csv`

The three CSV order entry files are loaded into GP with the SQL scripts
* load_order_items.sql
* load_aspirin_diapers.sql
* load_sausage_calmer.sql

## Building the app usable info

There are two tables generated by analysis of the order entry data.
* customer_favorites -- generated by build_customer_favorites.sql
* assoc_rules -- generated by run_assoc_rules.sql

### customer_favorites

The customer_favorites table lists, for each customer, the most common item  bought and the number of times the item was purchased.
The calculations used to compute this and the creation of the table are done in the SQL script `build_customer_favorites.sql`.

~~~
\d customer_favorites
Table "pivotalmarkets.customer_favorites"
   Column    |  Type   | Modifiers
-------------+---------+-----------
 customerid  | integer |
 productid   | integer |
 count       | bigint  |
 productname | text    |
Distributed randomly

select * from customer_favorites order by random() limit 10;
customerid | productid | count |           productname
-----------+-----------+-------+---------------------------------
      1784 |        44 |     4 | ground beef
      1178 |        49 |     5 | Leg of lamb
      1699 |        58 |     5 | Wonder Bread
      1556 |         2 |     3 | Ooopsi Cola
      1584 |         8 |     6 | banana
      1138 |        81 |     9 | Pivotal Extra Strength Aspirin
      1987 |        44 |     5 | ground beef
      1871 |        39 |     5 | Pivotal Soft and Smooth 24 pack
      1676 |        46 |     6 | Clucker Farms Organic Chicken
      1355 |        75 |     6 | Happy Valley Diced Tomatoes   
~~~
### assoc_rules

The analysis of which products tend to be bought together are done by the *apriori* algorithm of the MADlib *assoc_rules* module, which is described in the MADlib [assoc_rules](https://madlib.apache.org/docs/latest/group__grp__assoc__rules.html) documentation.

There are many brief introductions on this topic for non data scientists. This is a reasonable one: [Layman's Guide to Association Rules](https://dzone.com/articles/machinex-laymans-guide-to-association-rule-learnin)

Using the assoc_rules routine builds the assoc_rules table.  Altering the parameters in the call to the assoc_rules routine will generate different results.  It takes some experimentation to get reasonable results.
~~~
\d assoc_rules
    Table "pivotalmarkets.assoc_rules"
   Column   |       Type       | Modifiers
------------+------------------+-----------
 ruleid     | integer          |
 pre        | text[]           |
 post       | text[]           |
 count      | integer          |
 support    | double precision |
 confidence | double precision |
 lift       | double precision |
 conviction | double precision |
Distributed by: (ruleid)

select * from assoc_rules order by lift desc  limit 4;
-[ RECORD 1 ]---------------------------------------
ruleid     | 125
pre        | {"Pivotal Extra Stength Aspirin"}
post       | {"Devil's Delight Blazing Hot Sausage"}
count      | 644
support    | 0.107333333333333
confidence | 0.392443631931749
lift       | 2.67271485992111
conviction | 1.4042592778335
-[ RECORD 2 ]---------------------------------------
ruleid     | 65
pre        | {"Devil's Delight Blazing Hot Sausage"}
post       | {"Pivotal Extra Stength Aspirin"}
count      | 644
support    | 0.107333333333333
confidence | 0.730987514188422
lift       | 2.67271485992111
conviction | 2.70061814345992
-[ RECORD 3 ]---------------------------------------
ruleid     | 61
pre        | {"Pivotal Extra Stength Aspirin"}
post       | {"BabyBum Disposible Diapers"}
count      | 601
support    | 0.100166666666667
confidence | 0.366240097501523
lift       | 2.59438085597301
conviction | 1.35513990384615
-[ RECORD 4 ]---------------------------------------
ruleid     | 29
pre        | {"BabyBum Disposible Diapers"}
post       | {"Pivotal Extra Stength Aspirin"}
count      | 601
support    | 0.100166666666667
confidence | 0.709563164108619
lift       | 2.59438085597301
conviction | 2.50140447154472
~~~

# Trouble Shootings


Logs on server /data1/master/gpseg-1/pg_log
